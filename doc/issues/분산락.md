## ë™ì‹œì„± ë¬¸ì œ & ë¶„ì‚° ë½(ë ˆë””ìŠ¤)

- íŠ¹ì • ìœ ì €ê°€ íŠ¹ì • ê³µì—°(Concert), íŠ¹ì • íšŒì°¨(Schedule), íŠ¹ì • ì¢Œì„(Seat)ì„ ì˜ˆì•½í•œë‹¤.
- API ëŠ” ë™ì‹œì— ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ê°™ì€ ì¢Œì„ì„ ì°ì„ ìˆ˜ ìˆë‹¤. (ì˜ˆ: ì¸ê¸° ì¢Œì„ ì²« ì¤„ ìë¦¬)
- ê°™ì€ ì¢Œì„ì€ í•œ ëª…ë§Œ ì„±ê³µí•´ì•¼ í•œë‹¤.

## ë¬¸ì œ ìƒí™©(ì¥ì•  ìƒí™©)

**ReservationConcurrencyTest** ì—ì„œ 30ê°œì˜ ì“°ë ˆë“œê°€ ë™ì‹œì— ê°™ì€ ì¢Œì„ì„ ì˜ˆì•½ í•˜ë„ë¡ í˜¸ì¶œ
```java
int threadCount = 30;
// ...
ReservationResult result = reservationFacade.reservation("RESERVATION:" + seatId, command);
```
### ê¸°ëŒ€: 
- ì„±ê³µí•œ ì—ì•½ì€ 1ê±´

### ì‹¤ì œ:
- DBì— ë™ì¼í•œ ì¢Œì„ìœ¼ë¡œ ì˜ˆì•½ rowê°€ ë‹¤ìˆ˜ Insertë˜ëŠ” í˜„ìƒ ë°œìƒ 
  - 1ì°¨ ì‹œë„ 17ê±´, 2ì°¨ ì‹œë„ 29ê±´
- í…ŒìŠ¤íŠ¸ ê²€ì¦ì—ì„œ expected = 1 but was 29 ì™€ ê°™ì´ ì‹¤íŒ¨
> ì¦‰ ì„œë¡œ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ì‚¬ì‹¤ìƒ ë™ì‹œì— ê°™ì€ ì¢Œì„ì„ ì¡ëŠ” "ì¤‘ë³µ ì˜ˆì•½" ìƒíƒœê°€ ì¼ì–´ë‚¨

## ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí–ˆë‚˜?

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì½”ë“œê°€ ë™ì‹œì— ì‹¤í–‰ë¨
```java
public ReservationResult reservation(String lockName, ReservationCommand command) {
    
    ConcertSchedule schedule = concertService.getSchedule(command.scheduleId());
    
    Seat seat = concertService.getSeat(command.seatId());
    
    concertService.validateReservationAvailability(schedule, seat); // ì¢Œì„ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
    
    concertService.assignmentSeat(seat); // ì¢Œì„ ì ìœ  ì²˜ë¦¬
    
    Reservation reservation = reservationService.reservation(schedule, seat, command.userId());
    
    return ReservationResult.from(reservation, schedule, seat);
}
```
ë¬¸ì œëŠ” ì´ ì „ì²´ê°€ ë™ì‹œì— ì—¬ëŸ¬ ì“°ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ë©´
- ìŠ¤ë ˆë“œ Aì™€ ìŠ¤ë ˆë“œ Bê°€ ë™ì‹œì— seat ìƒíƒœë¥¼ ì¡°íšŒí•œë‹¤. -> ë‘˜ ë‹¤ "AVAILABLE"
- ë‘˜ ë‹¤ assignmentSeat()ë¥¼ í˜¸ì¶œ
- ë‘˜ ë‹¤ reservation insert
> ì¦‰ seat ì ìœ  ìƒíƒœ ë³€ê²½ì´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ê²Œ ë°˜ì˜ë˜ê¸° ì „ì— ë‹¤ìŒ ìŠ¤ë ˆë“œë„ ë˜‘ê°™ì€ ì¢Œì„±ì„ ì˜ˆì•½í•œë‹¤.

### 2. íŠ¸ëœì­ì…˜ ì»¤ë°‹ íƒ€ì´ë° ë•Œë¬¸ì— DBì—ë„ ì•„ì§ ë°˜ì˜ ì•ˆë¨
assignmentSeat()ë¡œ seat ìƒíƒœë¥¼ UNAVAILABLEë¡œ ë³€ê²½í•´ë„, ê·¸ê±´ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ê¸° ì „ê¹Œì§€ëŠ” DB ë°–(ë‹¤ë¥¸ íŠ¸ëœì­ì…˜)ì—ì„œëŠ” ì•ˆë³´ì¸ë‹¤.
-> ê·¸ë˜ì„œ ê±°ì˜ ë™ì‹œì— ë“¤ì–´ì˜¨ ìš”ì²­ë“¤ì€ ì„œë¡œ "ì•„ì§ ì¢Œì„ì´ ë¹„ì–´ìˆìŒ"ì´ë¼ê³  ë³¸ë‹¤.

### 3. ê²°ê³¼ì ìœ¼ë¡œ ë™ì‹œì„± ì œì–´ê°€ ì „í˜€ ì•ˆë¨
JPA ë‹¨ìœ„ @Transactionalë§Œìœ¼ë¡œëŠ” ë™ì‹œì— ë‹¬ë ¤ë“œëŠ” ìš”ì²­ì„ ìˆœì„œëŒ€ë¡œ ì§ë ¬í™”í•´ì£¼ì§€ ëª»í•œë‹¤. ë™ì¼ seatIdì— ëŒ€í•´ì„œ ìˆœì„œë¥¼ ê°•ì œë¡œ ë³´ì¥í•´ì¤˜ì•¼ í–ˆë‹¤.

## ì ìš©
### 1. AOP ê¸°ë°˜ ë¶„ì‚°ë½ ì• ë…¸í…Œì´ì…˜ ìƒì„±
```java
@DistributedLock(key = "#lockName")
@Transactional
public ReservationResult reservation(String lockName, ReservationCommand command) {
    // ì¢Œì„ ì¡°íšŒ / ê²€ì¦ / ì ìœ  / ì˜ˆì•½ ìƒì„±
}
```
"RESERVATION:" + seatId ë¥¼ lockNameìœ¼ë¡œ ì „ë‹¬í•´ì„œ ê°™ì€ ì¢Œì„ì´ë©´ ê°™ì€ ë½ í‚¤ë¥¼ ê³µìœ í•˜ë„ë¡ í•¨
### 2. AOP ë‚´ë¶€ ë™ì‘ 
```java
String key = "LOCK:" + ...; // ì¢Œì„ë§ˆë‹¤ ìœ ë‹ˆí¬í•œ ë½ í‚¤
RLock rLock = redissonClient.getLock(key);

boolean available = rLock.tryLock(waitTime, leaseTime, timeUnit);
if (!available) {
    throw new CoreException(ErrorType.LOCK_ACQUISITION_FAILED, key);
}

// ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
Object result = aopForTransaction.proceed(joinPoint);

if (available && rLock.isHeldByCurrentThread()) {
    rLock.unlock();
}
```
- tryLock()ì´ trueì¸ ìŠ¤ë ˆë“œ 1ê°œë§Œ ì•ˆìœ¼ë¡œ ë“¤ì–´ê°
- ë‚˜ë¨¸ì§€ ìŠ¤ë ˆë“œëŠ” false ë˜ëŠ” ëŒ€ê¸° í›„ ì˜ˆì™¸ ë°œìƒ
- ì˜ˆì•½ ë¡œì§ì´ í•œ ë²ˆì— í•œ ëª…ë§Œ ì‹¤í–‰

### 3. íŠ¸ëœì­ì…˜ ì •í•©ì„± ë¬¸ì œ ğŸ”¥
```text
[AOP ë½ íšë“] â†’ [@Transactional ì‹œì‘] â†’ [ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰] â†’ 
[@Transactional ì»¤ë°‹ ì „] â†’ [AOP finally ë¸”ë¡ì—ì„œ ë½ í•´ì œ]
```
ë½ì´ ë¨¼ì € í’€ë¦¬ê³  ë‚˜ì„œ DB íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ”ìƒí™©ì´ ë°œìƒ
- ìŠ¤ë ˆë“œ Aê°€ seatìƒíƒœë¥¼ UNAVAILABLEë¡œ ì—…ë°ì´íŠ¸ í–ˆì§€ë§Œ ì•„ì§ ì»¤ë°‹ ì „
- ë½ì´ í’€ë ¸ìœ¼ë‹ˆ ìŠ¤ë ˆë“œ Bê°€ ì§„ì…
- Bê°€ seatì„ ì¡°íšŒí•˜ë©´ ì•„ì§ "AVAILABLE" ìƒíƒœë¡œ ë³´ì„(Aì˜ ë³€ê²½ì‚¬í•­ ë¯¸ ì»¤ë°‹)
- Bë„ ì˜ˆì•½ ì„±ê³µ -> ì¤‘ë³µ ë°œìƒ

> ë½ì„ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì´í›„ í’€ì <br> ì¦‰, ë½ í•´ì œ ì‹œì ì„ ë‹¨ìˆœíˆ finally ë¸”ë¡ì´ ì•„ë‹Œ, ì»¤ë°‹ì´ ëë‚œ ì´í›„(after commit)ë¡œ ì˜®ê²¨ì•¼ í•œë‹¤.
```java
finally {
        if (lockAcquired && rLock.isHeldByCurrentThread()) {
        TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronizationAdapter() {
            @Override
            public void afterCommit() {
                try {
                    rLock.unlock();
                    log.info("[RedissonLock] ë½ í•´ì œ ì™„ë£Œ - lockKey: {}", lockKey);
                } catch (Exception e) {
                    log.warn("[RedissonLock] ì´ë¯¸ í•´ì œëœ ë½ ë˜ëŠ” ìŠ¤ë ˆë“œ ë¶ˆì¼ì¹˜ - lockKey: {}", lockKey);
                }
            }
        });
    }
}
```

## ê²€ì¦
### 1. Lockì´ ì ìš©ë˜ì§€ ì•Šì€ ê²½ìš°ì™€, íŠ¸ëœì­ì…˜ ì •í•©ì„± ë³´ì¥í•˜ì§€ ì•Šì€ ê²½ìš°ì˜ í…ŒìŠ¤íŠ¸
```text
threadCount = 30
ë™ì‹œì— ê°™ì€ seatId ì˜ˆì•½
ì„±ê³µ count â‰ˆ 17 ~ 29
```
ì¦‰ ê°™ì€ ì¢Œì„ì´ ì—¬ëŸ¬ ë²ˆ ì˜ˆì•½ë¨ -> ì¹˜ëª…ì  ë²„ê·¸

### 2.Lock + ì¢Œì„ìƒíƒœ ë°˜ì˜ í›„ í…ŒìŠ¤íŠ¸
```java
assertThat(successResults.size()).isEqualTo(1);
```
- ìˆ˜ì • ì „ 29ê±´ -> ìˆ˜ì • í›„ 1ê±´
- ë‚˜ë¨¸ì§€ ìŠ¤ë ˆë“œëŠ” ì˜ˆì™¸(CoreException:LOCK_ACQUISITION_FAILED ë˜ëŠ” ì¢Œì„ ë¶ˆê°€) ì²˜ë¦¬

### ReservationConcurrencyTest
```java
    @DisplayName("ë™ì‹œì— ê°™ì€ ì¢Œì„ ì˜ˆì•½ ìš”ì²­ ì‹œ, í•œ ëª…ë§Œ ì„±ê³µ")
    @Test
    public void ë™ì‹œì—_ê°™ì€ì¢Œì„_ì˜ˆì•½ì‹œ_í•œëª…ë§Œ_ì„±ê³µ () throws InterruptedException {
        //given
        Long concertId = 1L;
        Long concertScheduleId = 1L;
        Long seatId = 1L;

        int threadCount = 30;
        ExecutorService executorService = Executors.newFixedThreadPool(threadCount);
        CountDownLatch latch = new CountDownLatch(threadCount);

        List<ReservationResult> successResults = Collections.synchronizedList(new ArrayList<>());

        //when
        for (int i = 0; i < threadCount; i++) {
            long userId = i;
            executorService.submit(() -> {
                try {
                    ReservationCommand command = ReservationCommand.builder()
                            .userId(userId)
                            .concertId(concertId)
                            .scheduleId(concertScheduleId)
                            .seatId(seatId)
                            .build();

                    ReservationResult result = reservationFacade.reservation("RESERVATION:" + seatId, command);
                    successResults.add(result);
                } catch (Exception e) {
                    throw new RuntimeException(e);
                } finally {
                    latch.countDown();
                }
            });
        }
        latch.await();
        executorService.shutdown();

        //then
        assertThat(successResults.size()).as("ê°™ì€ ì¢Œì„ì— ëŒ€í•´ì„œëŠ” í•œëª…ë§Œ ì˜ˆì•½ ì„±ê³µí•´ì•¼ í•¨").isEqualTo(1);
    }
}
```

![123](../img/ReservationConcurrencyTest.png)
